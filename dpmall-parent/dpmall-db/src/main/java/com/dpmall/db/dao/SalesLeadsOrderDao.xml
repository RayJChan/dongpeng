<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.SalesLeadsOrderDao">
	<resultMap  id="SalesLeadsOrderResultMap" type="com.dpmall.db.bean.SalesLeadsOrderEntity">
		<result property="id" column="id"/>
		<result property="clientName" column="clientName"/>
        <result property="nickName" column="nickName"/>
        <result property="clientTel" column="clientTel"/>
        <result property="salesLeadsOrderCode" column="salesLeadsOrderCode"/>
        <result property="clientType" column="clientType"/>
        <result property="clientTypeId" column="clientTypeId"/>
        <result property="serverRegion" column="serverRegion"/>
        <result property="serverCity" column="serverCity"/>
        <result property="serverDistrict" column="serverDistrict"/>
        <result property="serverAddress" column="serverAddress"/>
        <result property="isAgency" column="isAgency"/>
        <result property="status" column="status"/>
        <result property="statusDescription" column="statusDescription"/>
        <result property="lastStatus" column="lastStatus"/>
        <result property="storeId" column="storeId"/>
        <result property="agencyId" column="agencyId"/>
        <result property="appStatusOfAgency" column="appStatusOfAgency"/>
        <result property="appStatusOfStore" column="appStatusOfStore"/>
        <result property="decorateSpace" column="decorateSpace"/>
        <result property="fitmentTime" column="fitmentTime"/>
        <result property="stylePreference" column="stylePreference"/>
        <result property="budget" column="budget"/>
        <result property="area" column="area"/>
        <result property="village" column="village"/>
        <result property="productPreference" column="productPreference"/>
        <result property="custBenefit" column="custBenefit"/>
        <result property="serviceRemark" column="serviceRemark"/>
        <result property="agencyRemark" column="agencyRemark"/>
        <result property="storeRemark" column="storeRemark"/>
        <result property="source" column="source"/>
        <result property="saleLeadsTime" column="saleLeadsTime"/>
        <result property="saleLeadsId" column="saleLeadsId"/>

        <result property="distributer" column="distributer"/>
        <result property="agencyAccept" column="agencyAccept"/>
        <result property="storeAccept" column="storeAccept"/>
        <result property="orderGuide" column="orderGuide"/>
        <result property="createdTime" column="createdTime"/>
        <result property="ordersTime" column="ordersTime"/>
        <result property="agencyAcceptTime" column="agencyAcceptTime"/>
        <result property="storeAcceptTime" column="storeAcceptTime"/>
        <result property="payPrice" column="payPrice"/>
        <result property="pictureNames" column="pictureNames"/>
        <result property="storeName" column="storeName"/>
        <result property="agencyName" column="agencyName"/>
        <result property="discountAmount" column="discountAmount"/>
        <result property="listStatusOfAgency" column="listStatusOfAgency"/>
        <result property="listStatusOfStore" column="listStatusOfStore"/>
        <result property="updateTime" column="updateTime"/>

        <result property="orderEvaluation" column="orderEvaluation"/>
        <result property="revisitTime" column="revisitTime"/>
        <result property="isLoss" column="isLoss"/>





	</resultMap>

    <select id="getList4AgencyOf" resultMap="SalesLeadsOrderResultMap">
        select
        yo.yixkhxxId AS saleLeadsId,
        yo.yixkhOrderId AS id,
        yo.yixkhNo AS salesLeadyorderCode,
        yo.yixkhStatus AS status,
        yo.yixkhStatusName AS statusDescription,
        yo.kehName AS clientName,
        yo.kehPhone AS clientTel,
        yo.fuwProvince AS serverRegion,
        yo.fuwCity AS serverCity,
        yo.fuwDistrict AS serverDistrict,
        yo.fuwAddress AS serverAddress,
        yo.isAgency AS isAgency,
        yo.zhuangxTime AS fitmentTime,
        yo.zhuangxSpace AS decorateSpace,
        yo.zhuangxArea AS area,
        yo.yixStyle AS stylePreference,
        yo.xiaofBudget AS budget,
        yo.xiaoqName AS village,
        yo.yixProduct AS productPreference,
        yo.liyPoint AS custBenefit,
        yo.kefRemarks AS serviceRemark,
        yo.agency_remark AS agencyRemark,
        yo.store_remark AS storeRemark,
        yo.yixkhlyPlatform AS source,
        yo.yixkh_last_status AS lastStatus,
        yo.dingdSum AS discountAmount,
        yo.dingdPicture AS pictureNames,
        yo.zhifSum AS payPrice,
        yo.appStatusOfAgency AS listStatusOfAgency,
        yo.appStatusOfStore AS listStatusOfStore,
        yo.appStatusOfAgency AS appStatusOfAgency,
        yo.appStatusOfStore AS appStatusOfStore,
        CONVERT (VARCHAR (20),yo.createTime,20) AS createdTime,
        CONVERT (VARCHAR (20),yo.createTime,20) AS ordersTime,
        CONVERT (VARCHAR(20), yo.jiedTime_jingxs, 20) AS agencyAcceptTime,
        CONVERT (VARCHAR(20), yo.jiedTime, 20) AS storeAcceptTime
        from
            tb_sal_yixkh_orders as yo
                where 1=1
                AND 144 >= DateDiff(hh,yo.createTime,getDate())
                AND yo.appStatusOfAgency IN ('WAITTING')
                AND yo.jingxsId = #{agencyId}
                <if test="search!=null and search !='' ">
                AND (
                yo.jingxsId LIKE '%${search}%'
                or yo.kehName LIKE '%${search}%'
                or yo.kehPhone LIKE '%${search}%'
                or yo.yixkhNo LIKE '%${search}%'
                )
              </if>
        order by yo.yixkhOrderId offset #{pageNum}-1 rows fetch next #{pageSize} rows only
    </select>


    <!--查询列表-->
	<select id="getList4AgencyOrStore" resultMap="SalesLeadsOrderResultMap">
        SELECT
            TOP ${pageSize} *
        FROM
            (
                SELECT
                    row_number () OVER (ORDER BY updateTime DESC) AS Times ,*
                FROM
                    (
                        SELECT
                            yo.jingxsId AS agencyId,
                            CONVERT (varchar(20),yo.createTime,20) AS saleLeadsTime,
                            CONVERT (varchar(20),yo.updateTime,20) AS updateTime,
                            yo.yixkhOrderId AS id,
                            yo.kehName AS clientName,
                            yo.kehPhone AS clientTel,
                            yo.yixkhNo AS salesLeadyorderCode,
                            yo.fuwProvince AS serverRegion,
                            yo.fuwCity AS serverCity,
                            yo.fuwDistrict AS serverDistrict,
                            yo.fuwAddress AS serverAddress,
                            yo.isAgency AS isAgency,
                            yo.yixkhStatus AS status,
                            yo.yixkhStatusName AS statusDescription,
                            yo.yixkh_last_status AS lastStatus,
                            yo.suggest_store_id AS storeId,
                            yo.suggest_store_name AS storeName,
                            yo.jingxsName AS agencyName,
                            yo.zhifSum AS payPrice,
                            yo.appStatusOfAgency AS listStatuyofAgency,
                            yo.appStatusOfStore AS listStatuyofStore
                        FROM
                            tb_sal_yixkh_orders yo
                        WHERE
                            1 = 1
                            AND yo.isO2O = '1'
                            <include refid="isAgency"/>
                            <!--<include refid="searchOfList"/>-->
                            <include refid="searchParam"/>
                            <include refid="statusSearchOfList"/>
                    ) a
            ) AS c
        WHERE
        Times &gt;= (${pageNum}-1)*${pageSize}+1
        ORDER BY
        Times
	</select>

   <!--列表数量-->
    <select id="getListCount" resultType="java.lang.String">

        SELECT
          count(*)
        FROM
        tb_sal_yixkh_orders yo
        WHERE
        1 = 1
        AND yo.isO2O = '1'
          <include refid="isAgency"/>
          <include refid="searchOfList"/>
          <include refid="searchParam"/>
          <include refid="statusSearchOfList"/>
    </select>


    <!--是否经销商-->
    <sql id="isAgency">
        <if test='isAgency == "Y"'>
            AND yo.isAgency = 'Y'
            AND yo.jingxsId = #{agencyOrStoreId}
            AND yo.appStatusOfAgency in <include refid="listStatus"/>
        </if>
        <if test='isAgency == "N"'>
            AND yo.isAgency = 'N'
            AND yo.suggest_store_id = #{agencyOrStoreId}
            AND yo.appStatusOfStore in <include refid="listStatus"/>
        </if>
    </sql>

    <sql id="searchParam">
        <if test="orderId != null and orderId !='' ">
          AND yo.yixkhNo = #{orderId}
        </if>
        <if test="clientName != null and clientName !='' ">
            AND yo.kehName = #{clientName}
        </if>
        <if test="clientTel != null and clientTel !='' ">
            AND yo.kehPhone = #{clientTel}
        </if>
        <if test="staRevisitTime != null and staRevisitTime !='' ">
            AND yo.revisit_time &gt;= #{staRevisitTime}
        </if>
        <if test="endRevisitTime != null and endRevisitTime !='' ">
            AND yo.revisit_time &lt;= #{endRevisitTime}
        </if>
    </sql>
    
    <!--列表状态-->
    <sql id="listStatus">
        <if test='listStatus == "1"'>
            ('WAITTING')
        </if>
        <if test='listStatus == "2"'>
            ('FLLOWING')
        </if>
        <if test='listStatus == "3"'>
            ('COMPLETED')
        </if>
    </sql>

    <!--搜索-->
    <sql id="searchOfList">
        <if test="search!=null and search !='' ">
            AND (
            yo.fuwAddress LIKE '%${search}%'
            or yo.kehName LIKE '%${search}%'
            or yo.kehPhone LIKE '%${search}%'
            or yo.yixkhNo LIKE '%${search}%'
            )
        </if>
    </sql>

    <!--搜索-->
    <sql id="statusSearchOfList">
        <if test="statusSearch!=null and statusSearch !='' ">
            AND   yo.yixkhStatus in('${statusSearch}')
        </if>
    </sql>


    <!--详情-->
    <select id="getDetails" resultMap="SalesLeadsOrderResultMap">
        SELECT
            yo.yixkhxxId AS saleLeadsId,
            yo.yixkhOrderId AS id,
            yo.yixkhNo AS salesLeadyorderCode,
            yo.yixkhStatus AS status,
            yo.yixkhStatusName AS statusDescription,
            yo.kehName AS clientName,
            yo.kehPhone AS clientTel,
            yo.fuwProvince AS serverRegion,
            yo.fuwCity AS serverCity,
            yo.fuwDistrict AS serverDistrict,
            yo.fuwAddress AS serverAddress,
            yo.isAgency AS isAgency,
            yo.zhuangxTime AS fitmentTime,
            yo.zhuangxSpace AS decorateSpace,
            yo.zhuangxArea AS area,
            yo.yixStyle AS stylePreference,
            yo.xiaofBudget AS budget,
            yo.xiaoqName AS village,
            yo.yixProduct AS productPreference,
            yo.liyPoint AS custBenefit,
            yo.kefRemarks AS serviceRemark,
            yo.agency_remark AS agencyRemark,
            yo.store_remark AS storeRemark,
            yx.laiyPlatform AS source,
            kh.kehName AS agencyAccept,
            suggest_store_name AS storeAccept,
            yo.yixkh_last_status AS lastStatus,
            yo.dingdSum AS discountAmount,
            yo.dingdPicture AS pictureNames,
            yo.zhifSum AS payPrice,
            yo.appStatusOfAgency AS listStatusOfAgency,
            yo.appStatusOfStore AS listStatusOfStore,
            yo.appStatusOfAgency AS appStatusOfAgency,
            yo.appStatusOfStore AS appStatusOfStore,
            CONVERT (VARCHAR (20),yx.createTime,20	) AS saleLeadsTime,
            CONVERT (VARCHAR (20),yo.createTime,20) AS createdTime,
            CONVERT (VARCHAR (20),yo.createTime,20) AS ordersTime,
            CONVERT (VARCHAR(20), yo.jiedTime_jingxs, 20) AS agencyAcceptTime,
            CONVERT (VARCHAR(20), yo.jiedTime, 20) AS storeAcceptTime
        FROM
            tb_sal_yixkh_orders yo
            LEFT JOIN tb_sal_yixkhxx_list yx ON yx.id = yo.yixkhxxId
            LEFT JOIN dbo.tb_sys_record_keh kh   ON kh.kehID = yo.jingxsId

        WHERE
            1 = 1
            AND yo.yixkhOrderId = #{id}
    </select>





    <!--更新留资单-->
    <update id="edit">
        <if test="entity.id!=null and entity.id!='' ">
            update tb_sal_yixkh_orders

            <set>
                updateTime = SYSDATETIME(),
                <if test="entity.failType!=null and entity.failType!='' ">
                    fail_type=#{entity.failType},
                </if>
                <if test="entity.failReason!=null and entity.failReason!=''">
                    fail_reason=#{entity.failReason},
                </if>

                <if test="entity.refuseRemark!=null">
                    refuse_remark=#{entity.refuseRemark},
                </if>
                <if test="entity.refuseType!=null">
                    refuse_type=#{entity.refuseType},
                </if>
                <if test="entity.refuseTime!=null">
                    refuse_time=#{entity.refuseTime},
                </if>
                <if test="entity.saleLeadsOrderStatus!=null">
                    yixkhStatus=#{entity.saleLeadsOrderStatus},
                </if>
                <if test="entity.saleLeadsOrderStatusName!=null">
                    yixkhStatusName=#{entity.saleLeadsOrderStatusName},
                </if>
                <if test="entity.acceptTime!=null">
                    jiedTime=#{entity.acceptTime},
                </if>
                <if test="entity.agencyAcceptTime!=null">
                    jiedTime_jingxs=#{entity.agencyAcceptTime},
                </if>
                <if test="entity.suggestStore!=null">
                    suggest_store_id=#{entity.suggestStore},
                </if>
                <if test="entity.isAgency!=null">
                    isAgency=#{entity.isAgency},
                </if>
                <if test="entity.appStatusofAgency!=null">
                    appStatusOfAgency=#{entity.appStatusofAgency},
                </if>
                <if test="entity.appStatusofStore!=null">
                    appStatusOfStore=#{entity.appStatusofStore},
                </if>
                <if test="entity.orderGuide!=null">
                    P_ORDERGUIDE=#{entity.orderGuide},
                </if>
                <if test="entity.agencyAccept!=null">
                    jingxsId=#{entity.agencyAccept},
                </if>
                <if test="entity.storeAcceptRemark!=null and entity.storeAcceptRemark!=''">
                    store_remark=#{entity.storeAcceptRemark},
                </if>
                <if test="entity.agencyRemark!=null and entity.agencyRemark!=''">
                    agency_remark=#{entity.agencyRemark},
                </if>

                <if test="entity.clientName!=null and entity.clientName!=''">
                    kehName=#{entity.clientName},
                </if>
                <if test="entity.clientTel!=null and entity.clientTel!=''">
                    kehPhone=#{entity.clientTel},
                </if>
                <if test="entity.serverRegion!=null and entity.serverRegion!=''">
                    fuwProvince=#{entity.serverRegion},
                </if>
                <if test="entity.serverCity!=null and entity.serverCity!=''">
                    fuwCity=#{entity.serverCity},
                </if>
                <if test="entity.serverDistrict!=null and entity.serverDistrict!=''">
                    fuwDistrict=#{entity.serverDistrict},
                </if>
                <if test="entity.serverAddress!=null and entity.serverAddress!=''">
                    fuwAddress=#{entity.serverAddress},
                </if>
                <if test="entity.clientType!=null and entity.clientType!=''">
                    kehType=#{entity.clientType},
                </if>
                <if test="entity.decorateSpace!=null and entity.decorateSpace!=''">
                    zhuangxSpace=#{entity.decorateSpace},
                </if>
                <if test="entity.fitmentTime!=null and entity.fitmentTime!=''">
                    zhuangxTime=#{entity.fitmentTime},
                </if>
                <if test="entity.stylePreference!=null and entity.stylePreference!=''">
                    yixStyle=#{entity.stylePreference},
                </if>
                <if test="entity.budget!=null and entity.budget!=''">
                    xiaofBudget=#{entity.budget},
                </if>
                <if test="entity.area!=null and entity.area!=''">
                    zhuangxArea=#{entity.area},
                </if>
                <if test="entity.village!=null and entity.village!=''">
                    xiaoqName=#{entity.village},
                </if>
                <if test="entity.productPreference!=null and entity.productPreference!=''">
                    yixProduct=#{entity.productPreference},
                </if>

                <if test="entity.custBenefit!=null and entity.custBenefit!=''">
                    liyPoint=#{entity.custBenefit},
                </if>
                <if test="entity.lastStatus!=null and entity.lastStatus!=''">
                    yixkh_last_status=#{entity.lastStatus},
                </if>

                <if test="entity.pictureNames!=null and entity.pictureNames!=''">
                    dingdPicture  =#{entity.pictureNames},
                </if>
                <if test="entity.payPrice!=null and entity.payPrice!=''">
                    zhifSum=#{entity.payPrice},
                </if>
                <if test="entity.discountAmount!=null and entity.discountAmount!=''">
                    dingdSum=#{entity.discountAmount},
                </if>

                <if test="entity.finishedTime!=null">
                    finished_time=#{entity.finishedTime},
                </if>

                <if test="entity.orderEvaluation!=null and entity.orderEvaluation!=''">
                    order_evaluation=#{entity.orderEvaluation},
                </if>

                <if test="entity.revisitTime!=null">
                    revisit_time = #{entity.revisitTime},
                </if>

                <if test="entity.isLoss!=null and entity.isLoss!=''">
                    is_loss=#{entity.isLoss},
                </if>



            </set>


                where yixkhOrderId=#{entity.id}
        </if>

    </update>

    <!--留资订单是否全部已下派-->
    <update id="editSaleLeads">
        UPDATE SALESLEADS
        <set>
            MODIFIEDTS=sysdate,
            <if test='entity.saleLeadsOrderStatus=="REJECTED"'>
                P_ORDERDISTRIBUTEDFLAG = '0'
            </if>
        </set>
        <if test="entity.id!=null">
            WHERE
            pk = (
            SELECT
            s.pk
            FROM
            SALESLEADS s
            LEFT JOIN SALESLEADSORDER so ON SO.P_SALESLEADS = s.PK
            WHERE
            so.pk = #{entity.id}
            )
        </if>
    </update>

    <select id="getLastStatus" resultType="java.lang.String">
        SELECT
            P_SALESLEADSORDERSTATUS
        FROM
            SALESLEADSORDER
        WHERE
            PK = #{id}

    </select>

    <select id="getIsAgency" resultType="java.lang.String">
        SELECT
         P_ISAGENCY
        FROM
         SALESLEADSORDER
        WHERE
          PK = #{id}

    </select>


    <select id="getCountUnOperate" resultType="java.lang.Integer">
        SELECT
            count (1) as count
        FROM
            SALESLEADSORDER s
        WHERE
            1 = 1
            AND "TO_CHAR" (SYSDATE - 3, 'yyyy-mm-dd') > "TO_CHAR" (s.MODIFIEDTS, 'yyyy-mm-dd')
            AND s.P_APPSTATUSOFAGENCY IN ('WAITTING', 'FLLOWING')
            AND s .P_AGENCY = #{agencyId}

    </select>
    
    <select id="getCountUnWaitting" resultType="java.lang.Integer">
        SELECT
            count (1) as count
        FROM
            tb_sal_yixkh_orders s
        WHERE
            1 = 1
            AND 144 >= DateDiff(hh,s.createTime,getDate())
            AND s.appStatusOfAgency IN ('WAITTING')
            AND s .jingxsId = #{agencyId}

    </select>

    <select id = "getStoreBySal" resultType="com.dpmall.db.bean.StoreOfSalEntity">
        SELECT
            P .P_DISPLAYNAME as storeName,
            P .P_REGION || P .P_CITY || P .P_DISTRICT || P .P_FORMATADDRESS AS storeAddress,
            P .P_PHONENUMBER as storePhone,
            s.P_CUSTBENEFIT as  custbenefit,
            s.P_TELEPHONE as customerPhone
        FROM
            SALESLEADSORDER s,
            POINTOFSERVICE P
        WHERE
            s.P_SUGGESTSTORE = P .pk
            AND s.pk = #{salPk}

    </select>

    <!--查询订单评价、状态、流失情况、回访时间-->

    <select id="getStatusInfoById" resultMap="SalesLeadsOrderResultMap">
        SELECT order_evaluation as orderEvaluation,
            is_loss as isLoss,
            revisit_time as revisitTime,
            yixkhStatus as status,
            yixkhStatusName as statusDescription
        FROM dbo.tb_sal_yixkh_orders
        WHERE
            yixkhOrderId  = #{id}


    </select>


</mapper>
