<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.FirstPageDao">

	<resultMap id="FirstPageResultMap" type="com.dpmall.db.bean.FirstPageEntity">
		<id property="id" column="PK" />
		<result property="referencedCode" column="P_EXTERNALORDERCODE" />
	</resultMap>

	<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
	<!-- 留资线索数 经销商 -->
	<select id="salesLeadsCount" resultType="java.math.BigDecimal">
		SELECT
		count(*)
		FROM
		tb_sal_yixkh_orders yo
		WHERE
		1 = 1
		AND yo.isO2O = '1'
		<include refid="salIsAgency"/>

		AND yo.createTime &gt;= #{startdate}
		AND yo.createTime &lt;= #{enddate}


	</select>

	<!--是否经销商-->
	<sql id="salIsAgency">
		<if test='isStore == "N"'>
			AND yo.jingxsId IN

			<foreach collection="list" index="index" item="item" open="("
					 separator="," close=")">
				#{item}
			</foreach>

			AND yo.appStatusOfAgency in <include refid="salListStatus"/>
		</if>
		<if test='isStore == "Y"'>
			AND yo.isAgency = 'N'
			AND yo.suggest_store_id = #{storeId}
			AND yo.appStatusOfStore in <include refid="salListStatus"/>
		</if>
	</sql>
	<!--列表状态-->
	<sql id="salListStatus">
		<if test='status == "1"'>
			('WAITTING')
		</if>
		<if test='status == "2"'>
			('FLLOWING')
		</if>
		<if test='status == "3"'>
			('COMPLETED')
		</if>
	</sql>


	<select id="salesLeadsCount_Today" resultType="java.math.BigDecimal">
		SELECT
		count(*)
		FROM
		tb_sal_yixkh_orders yo
		WHERE
		1 = 1
		AND yo.isO2O = '1'
		<include refid="salIsAgency"/>

		AND yo.revisit_time = convert(varchar(10),getdate(),120)


	</select>

	<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->


	<sql id="isAgency_Order">
		<if test='isAgency == "Y"'>
			AND xt.fenxkhCode in
			<foreach collection="list" index="index" item="item" open="("
					 separator="," close=")">
				#{item}
			</foreach>
			<if test='status=="1"'>
				AND xt.app_status_agency ='WAITFORRECEIVE'
			</if>
			<if test='status=="2"'>
				AND xt.app_status_agency ='INPROGRESS'
			</if>
			<if test='status=="3"'>
				AND xt.app_status_agency ='WAITFORREFUND'
			</if>
			<if test='status=="4"'>
				AND xt.app_status_agency in ('COMPLETED','CLOSED')
			</if>
		</if>

		<if test='isAgency == "N"'>
			and xt.isDeliverSelf = 'N'
			AND xt.suggest_store =  #{storeId}
			AND xt.app_status_store in
			<if test='status=="1"'>
				('WAITFORRECEIVE')
			</if>
			<if test='status=="2"'>
				('INPROGRESS')
			</if>
			<if test='status=="3"'>
				('WAITFORREFUND')
			</if>
			<if test='status=="4"'>
				('COMPLETED','CLOSED')
			</if>

		</if>
	</sql>

	<!-- 实物订单 经销商 -->

	<select id="orderCount" resultType="java.math.BigDecimal">
		SELECT
		count(*)
		FROM
		dbo.tb_sd_xiaos_title xt

		INNER JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID
		WHERE
		1 = 1
		AND dt.dingdLeix = '1'
		AND dt.convertFlag = '1'

		<include refid="isAgency_Order"/>
		AND xt.chuangjTime &gt;= #{startdate}
		AND xt.chuangjTime &lt;= #{enddate}

	</select>



	<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

		<!--天猫特权判断-->
	<sql id="isAgency_TmallPrePay">
		<if test='isAgency == "Y"'>
			AND xt.fenxkhCode in
			<foreach collection="list" index="index" item="item" open="("
					 separator="," close=")">
				#{item}
			</foreach>
			<if test='listStatus == "1"'>
				aND xt.app_status_agency = 'WAITFORRECEIVE'
			</if>
			<if test='listStatus == "2"'>
				AND xt.app_status_agency in('INPROGRESS','COMPLETED')

				AND (dt.yuansdStatus != 'TRADE_CLOSED' or dt.yuansdStatus != 'TRADE_CANCELED' or dt.yuansdStatus is null)
			</if>
			<if test='listStatus == "3"'>
				AND xt.app_status_agency in('INPROGRESS','COMPLETED')
				AND (dt.yuansdStatus != 'TRADE_CLOSED' or dt.yuansdStatus != 'TRADE_CANCELED' or dt.yuansdStatus  is null)

			</if>
			<if test='listStatus == "4"'>
				AND (dt.yuansdStatus = 'TRADE_CLOSED' or dt.yuansdStatus = 'TRADE_CANCELED')
			</if>
		</if>

		<if test='isAgency == "N"'>
			and xt.isDeliverSelf = 'N'
			AND xt.suggest_store = #{storeId}
			<if test='listStatus == "1"'>
				aND app_status_store = 'WAITFORRECEIVE'
			</if>
			<if test='listStatus == "2"'>
				aND app_status_store in ('INPROGRESS','COMPLETED')
				AND (dt.yuansdStatus != 'TRADE_CLOSED' or dt.yuansdStatus != 'TRADE_CANCELED' or dt.yuansdStatus is null)
			</if>
			<if test='listStatus == "3"'>
				aND app_status_store in ('INPROGRESS','COMPLETED')
				AND (dt.yuansdStatus != 'TRADE_CLOSED' or dt.yuansdStatus != 'TRADE_CANCELED' or dt.yuansdStatus  is null)
			</if>
			<if test='listStatus == "4"'>
				AND (dt.yuansdStatus = 'TRADE_CLOSED' or dt.yuansdStatus = 'TRADE_CANCELED')
			</if>

		</if>
	</sql>

	<!-- 天猫特权订金 经销商/门店 -->
	<select id="tmallPrepayCount" resultType="java.math.BigDecimal">
		SELECT
		count(*)
		FROM
		dbo.tb_sd_xiaos_title xt
		INNER JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID

		WHERE
		1 = 1
		AND xt.xiaosTitleID
		IN (
		SELECT
		xt.xiaosTitleID
		FROM
		dbo.tb_sd_xiaos_title xt
		inner JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID
		WHERE
		1 = 1
		AND dt.dingdLeix = '2'

		<include refid="isAgency_TmallPrePay"/>
		)
		AND xt.chuangjTime &gt;= #{startdate}
		AND xt.chuangjTime &lt;= #{enddate}
	</select>



	<select id="tmallPrepayCount_Today" resultType="java.math.BigDecimal">
		SELECT
		count(*)
		FROM
		dbo.tb_sd_xiaos_title xt
		INNER JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID

		WHERE
		1 = 1
		AND xt.xiaosTitleID
		IN (
		SELECT
		xt.xiaosTitleID
		FROM
		dbo.tb_sd_xiaos_title xt
		inner JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID
		WHERE
		1 = 1
		AND dt.dingdLeix = '2'

		<include refid="isAgency_TmallPrePay"/>
		)
		AND xt.revisitTime = convert(varchar(10),getdate(),120)
	</select>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->




	<!-- 其他特权订金 经销商 -->
	<select id="othersPrepayCountOfAgency" resultType="java.math.BigDecimal">
		SELECT
		count(*)
		FROM
		CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		inner JOIN ORDERS o ON o.PK = c.P_ORDER
		inner JOIN ENUMERATIONVALUES E2 ON o.P_SALESAPPLICATION = E2.PK
		WHERE
		1=1
		AND E2.code != 'Tmall'
		AND ( c.P_ALLOCATIONEMPLOYEECODE IN
		<foreach collection="list" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
		<if test="bigList != null">
			<foreach collection="bigList" index="index" item="item2">
				or c.P_ALLOCATIONEMPLOYEECODE in
				<foreach collection="item2" index="index" item="item3" open="("
					separator="," close=")">
					#{item3}
				</foreach>
			</foreach>
		</if>)
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
 		AND c.P_SPLITORDERTYPE = 'M2'
		<if test='status=="1"'>
			AND O2O.P_AGENCYO2OSTATUS ='WAITFORRECEIVE'
		</if>
		<if test='status=="2"'>
			AND O2O.P_AGENCYO2OSTATUS ='INPROGRESS'
		</if>
		<if test='status=="3"'>
			AND O2O.P_AGENCYO2OSTATUS ='COMPLETED'
		</if>
	</select>



	<!-- 其他特权订金 门店 -->
	<select id="othersPrepayCountOfStore" resultType="java.math.BigDecimal">
		SELECT
		count(*)
		FROM
		CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		inner JOIN ORDERS o ON o.PK = c.P_ORDER
		inner JOIN ENUMERATIONVALUES E2 ON o.P_SALESAPPLICATION = E2.PK
		WHERE
		1=1
		AND E2.code != 'Tmall'
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
		AND	TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		AND	c.P_SPLITORDERTYPE = 'M2'
		AND C.P_STATUS IN (
			SELECT
				t2.pk
			FROM
				COMPOSEDTYPES t1,
				ENUMERATIONVALUES t2
			WHERE
				t1.INTERNALCODe ='ConsignmentStatus'
			AND t2.TYPEPKSTRING = t1.PK
				<if test='status=="1"'>
					AND t2.code ='STOREWAIT'
				</if>
				<if test='status=="2"'>
					AND t2.code IN ('TOSTORE','ALLOCATED','BOOKED','SHIPPED','DPRECEIVE','ACCEPT')
				</if>
				<if test='status=="3"'>
					AND t2.code  in ('COMPLETED','RECEIVE','NOTTRADED')
				</if>
		)
		and P_DELIVERYPOINTOFSERVICE = #{storeId}

	</select>


	<resultMap id="historylMap" type="com.dpmall.db.bean.FirstPageEntity">
		<result property="lastConversionRate" column="lastConversionRate" />
		<result property="lastAcceptRate" column="lastAcceptRate" />
		<result property="lastWriteOffRate" column="lastWriteOffRate" />
	</resultMap>

	<select id="getHistory" resultMap="historylMap">
		SELECT
			HR.P_JDTOTALPERCENT AS lastAcceptRate,
			HR.P_TQHXPERCENT AS lastWriteOffRate,
			HR.P_LZZHPERCENT AS lastConversionRate
		FROM
			HISTORICRECORDS hr
		WHERE
		1=1
		<if test='isStore=="N"'>
		and	HR.P_APPGROUP IN (
				SELECT
					pk
				FROM
					APPGROUP
				WHERE
					P_CODE = #{code}
			)
		</if>
		<if test='isStore=="Y"'>
			and HR.P_STORE = #{storeId}
		</if>
		AND TO_CHAR (HR.P_TIME, 'YYYY-MM-dd')  &gt;= #{startdate}
		AND TO_CHAR (HR.P_TIME, 'YYYY-MM-dd') &lt;= #{enddate}


	</select>



</mapper>