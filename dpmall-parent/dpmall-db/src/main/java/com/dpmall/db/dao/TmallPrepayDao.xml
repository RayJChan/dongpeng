<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.TmallPrepayDao">
	<select id="getList" resultMap="tmallPrepayMap">
		SELECT
			xt.xiaosTitleID as prePayId,
			xt.isDeliverSelf AS isAgency,
			xt.cankNo as  prePayCode,
			xt.shouhMan AS prePayName,
			xt.suggest_store as suggestStoreName,
			CONVERT (varchar(10),xt.chuangjTime,23) AS effectiveTime,
			xt.shouhAddress AS serviceAddress,
			xt.accept_time  AS acceptTime,
			xt.shouhTel as phone,
			xt.fenxkhCode,
			xt.fenxkhName as agencyName

		FROM
			dbo.tb_sd_xiaos_title xt
		LEFT JOIN dbo.tb_sd_xiaos_list xl ON xt.xiaosTitleID = xl.xiaosTitleID
		LEFT JOIN dbo.tb_sys_record_shangp sp ON sp.shangpID = xl.shangpID
		LEFT JOIN dbo.tb_sd_tuih_title tt ON xt.xiaosTitleID = tt.xiaosTitleID
		INNER JOIN dbo.tb_sys_record_keh kh ON kh.kehCode = xt.kehCode
		INNER JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID
		INNER JOIN dbo.tb_sys_record_org org ON dt.yewOrgID =org.orgID

		WHERE
		1 = 1
		--AND sp.shangpType = '0'
		AND xt.xiaosTitleID
			IN (
			SELECT
				TOP ${pageSize}  c.xiaosTitleID
			FROM
				(
				SELECT
				row_number () OVER (ORDER BY chuangjTime DESC) AS rownumber ,*
				FROM
					(
					SELECT
						xt.xiaosTitleID,
						xt.chuangjTime,xt.fenxkhCode
					FROM
						dbo.tb_sd_xiaos_title xt
					inner JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID
					WHERE
						1 = 1
						AND dt.dingdLeix = '2'
						--AND dt.convertFlag = '1'
						<include refid="isAgency"/>

					) AS o
				) AS c
			WHERE
				rownumber &gt;= (${pageNum}-1)*${pageSize}+1
			ORDER BY rownumber
			)
		ORDER BY xt.chuangjTime DESC;
	</select>

	<resultMap id="tmallPrepayMap" type="com.dpmall.db.bean.TmallPrePayEntity">
		<id property="prePayId" column="prePayId" />
		<result property="prePayCode" column="prePayCode" />
		<result property="prePayName" column="prePayName" />
		<result property="suggestStoreName" column="suggestStoreName" />
		<result property="effectiveTime" column="effectiveTime" />
		<result property="serviceAddress" column="serviceAddress" />
		<result property="acceptTime" column="acceptTime" />
		<result property="phone" column="phone" />
		<result property="isAgency" column="isAgency" />
		<result property="storeStatus" column="storeStatus" />
		<result property="agencyName" column="agencyName" />

	</resultMap>

	<select id="getListCount" resultType="java.lang.String">
		SELECT
			count(*)
		FROM
			dbo.tb_sd_xiaos_title xt
		INNER JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID

		WHERE
		1 = 1
		AND xt.xiaosTitleID
		IN (
			SELECT
			xt.xiaosTitleID
			FROM
			dbo.tb_sd_xiaos_title xt
			inner JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID
			WHERE
			1 = 1
			AND dt.dingdLeix = '2'
			<include refid="isAgency"/>
			<include refid="searchParam"/>
			<include refid="searchOfList"/>
		)
	</select>

	<!--跟进中筛选-->
	<sql id="searchParam">
		<if test="orderId != null and orderId !='' ">
			AND xt.xiaosNo = #{orderId}
		</if>
		<if test="clientName != null and clientName !='' ">
			AND xt.shouhMan = #{clientName}
		</if>
		<if test="clientTel != null and clientTel !='' ">
			AND xt.shouhTel = #{clientTel}
		</if>
		<if test="staRevisitTime != null and staRevisitTime !='' ">
			AND xt.revisitTime &gt;= #{staRevisitTime}
		</if>
		<if test="endRevisitTime != null and endRevisitTime !='' ">
			AND  xt.revisitTime &lt;= #{endRevisitTime}
		</if>
	</sql>

	<!--搜索-->
	<sql id="searchOfList">
		<if test="search!=null and search !='' ">
			AND (
				xt.shouhMan LIKE '%${search}%'
			or xt.xiaosNo LIKE '%${search}%'
			or xt.shouhTel LIKE '%${search}%'
			)
		</if>
	</sql>

	<sql id="isAgency">
		<if test='isAgency == "Y"'>
			 AND xt.fenxkhCode =  #{agencyId}
			<if test='listStatus == "1"'>
				aND xt.app_status_agency = 'WAITFORRECEIVE'
			</if>
			<if test='listStatus == "2"'>
				AND xt.app_status_agency in('INPROGRESS','COMPLETED')
				AND (dt.yuansdStatus != 'TRADE_CLOSED' or dt.yuansdStatus != 'TRADE_CANCELED' or dt.yuansdStatus is null)
			</if>
			<if test='listStatus == "3"'>
				AND xt.app_status_agency in('INPROGRESS','COMPLETED')
				AND (dt.yuansdStatus != 'TRADE_CLOSED' or dt.yuansdStatus != 'TRADE_CANCELED' or dt.yuansdStatus  is null)
			</if>
			<if test='listStatus == "4"'>
				AND (dt.yuansdStatus = 'TRADE_CLOSED' or dt.yuansdStatus = 'TRADE_CANCELED')
			</if>
		</if>

		<if test='isAgency == "N"'>
			and xt.isDeliverSelf = 'N'
			AND xt.suggest_store = #{storeId}
			<if test='listStatus == "1"'>
				aND app_status_store = 'WAITFORRECEIVE'
			</if>
			<if test='listStatus == "2"'>
				aND app_status_store in ('INPROGRESS','COMPLETED')
			</if>
			<if test='listStatus == "3"'>
				aND app_status_store in ('INPROGRESS','COMPLETED')
			</if>
			<if test='listStatus == "4"'>
				AND (dt.yuansdStatus = 'TRADE_CLOSED' or dt.yuansdStatus = 'TRADE_CANCELED')
			</if>

		</if>
	</sql>

    <select id="getOrderDetails" resultType="java.lang.String">
        select
            oms_status
          from
            tb_sd_xiaos_title
            where xiaosTitleID = #{prePayId}
    </select>

	<update id="editXiaoTitle">
		<if test="po.prePayId!=null and po.prePayId!='' ">
		UPDATE dbo.tb_sd_xiaos_title
		<set>
			<if test='po.prepayStatus != null and po.prepayStatus != "" '>
				oms_status = #{po.prepayStatus},
			</if>
			<if test='po.prepayStatusName != null and po.prepayStatusName != "" '>
				prepayStatusName = #{po.prepayStatusName},
			</if>
			<if test='po.lastPrepayStatus != null and po.lastPrepayStatus != "" '>
				lastPrepayStatus = #{po.lastPrepayStatus},
			</if>
-- 			finishedTime = GETDATE(),
			<if test='po.amount != null and po.amount != "" '>
				amount = #{po.amount},
			</if>
			<if test="po.pictureNames!=null and po.pictureNames!=''">
				dingdPicture  =#{po.pictureNames},
			</if>
			<if test="po.orderEvaluation!=null and po.orderEvaluation!=''">
				orderEvaluation  =#{po.orderEvaluation},
			</if>
			<if test="po.isLoss!=null and po.isLoss!=''">
				isLoss  =#{po.isLoss},
			</if>
			<if test="po.revisitTime!=null and po.revisitTime!=''">
				revisitTime  =#{po.revisitTime},
			</if>
			<if test="po.failType!=null and po.failType!=''">
				failType  =#{po.failType},
			</if>
			<if test="po.failReason!=null and po.failReason!=''">
				failReason  =#{po.failReason},
			</if>
			<if test='po.agencyListStatus != null and po.agencyListStatus != "" '>
				app_status_agency = #{po.agencyListStatus},
			</if>
			<if test='po.storeListStatus != null and po.storeListStatus != "" '>
				app_status_store = #{po.storeListStatus},
			</if>
			<if test='po.isDeliverySelf != null and po.isDeliverySelf != "" '>
				isDeliverSelf = #{po.isDeliverySelf},
			</if>
			<if test='po.storeRemark != null and po.storeRemark != "" '>
				store_remark = #{po.storeRemark},
			</if>
			<if test='po.agencyRemark != null and po.agencyRemark != "" '>
				agency_remark = #{po.agencyRemark},
			</if>
			<if test='po.tmallAcceptTime == "Y" '>
				accept_time = GETDATE(),
			</if>
			<if test='po.tmallAcceptTime == "N" '>
				accept_time =  null,
				suggest_store = NULL,
				app_status_store = NULL,
			</if>
			<if test='po.suggestStore != null and po.suggestStore != "" '>
				suggest_store = #{po.suggestStore},
			</if>

		</set>
		where xiaosTitleID  = #{po.prePayId}
		</if>
	</update>

	<update id="withdraw">
		<if test="po.prePayId!=null and po.prePayId!='' ">
		UPDATE dbo.tb_sd_xiaos_title
		<set>
			accept_time =  null,
			suggest_store = NULL,
			app_status_store = NULL,
			store_remark = null,
			oms_status = #{po.prepayStatus},
			isDeliverSelf = #{po.isDeliverySelf}
		</set>
			where xiaosTitleID  = #{po.prePayId}
		</if>
	</update>


	<update id="editConsignment">
		<if test="po.prePayId!=null and po.prePayId!='' ">
		UPDATE CONSIGNMENTS
		<set>
			MODIFIEDTS=sysdate,
			<if test='po.prepayStatus != null and po.prepayStatus != "" '>
				P_STATUS = #{po.prepayStatus},
			</if>
			<if test='po.suggestStore != null and po.suggestStore != "" '>
				P_DELIVERYPOINTOFSERVICE = #{po.suggestStore},
			</if>


		</set>
		where PK=#{po.prePayId}
		</if>
	</update>

	<resultMap id="detailsMap" type="com.dpmall.db.bean.TmallPrePayDetailEntity">
		<id property="prePayId" column="prePayId" />
		<result property="prePayCode" column="prePayCode" />
		<result property="prePayName" column="prePayName" />
		<result property="discountPrice" column="discountPrice" />
		<result property="condition" column="condition" />
		<result property="customerName" column="customerName" />
		<result property="phone" column="phone" />
		<result property="serviceAddress" column="serviceAddress" />
		<result property="effectiveTime" column="effectiveTime" />
		<result property="customerName" column="customerName" />
		<result property="suggestStoreName" column="suggestStoreName" />
		<result property="agencyRemark" column="agencyRemark" />
		<result property="storeRemark" column="storeRemark" />
		<result property="prepayStatus" column="prepayStatus" />
		<result property="acceptTime" column="acceptTime" />
		<result property="writeoffCode" column="writeoffCode" />
		<result property="isWriteOff" column="isWriteOff" />
		<result property="listStatusOfAgency" column="listStatusOfAgency" />
		<result property="listStatusOfStore" column="listStatusOfStore" />
		<result property="isAgency" column="isAgency" />
		<result property="agencyId" column="agencyId" />
        <result property="sfStatus" column="sfStatus" />
		<result property="serviceRemark" column="serviceRemark" />
		<result property="agencyName" column="agencyName" />
		<result property="oms_status" column="oms_status" />
	</resultMap>

	<!--获取详情-->
	<select id="getDetails" resultMap="detailsMap">
		SELECT
-- 			kh.kehID AS agencyId,
			xt.isDeliverSelf AS isAgency,
			xt.xiaosTitleID AS prePayId,
			xt.cankNo AS prePayCode,
-- 			sp.miaos AS prePayName,
			CONVERT (VARCHAR (10),xt.chuangjTime,23	) AS effectiveTime,
			xt.shouhTel AS phone,
			xt.kehName AS customerName,
			xt.fenxkhName AS agencyName,
			xt.shouhAddress AS serviceAddress,
			xt.suggest_store AS suggestStoreName,
			--O2O.P_AGENCYCOMMENT AS agencyRemark,
			--O2O.P_ACCEPTEDCOMMENT AS storeRemark,
			--PR.P_DESCRIPTION AS condition,
			CONVERT(varchar(20), xt.accept_time, 20) AS acceptTime ,
			xt.oms_status AS prepayStatus,
			--PR.P_PRIDEPOSITCODE AS writeoffCode,
			--PR.P_ISWRITEOFF AS isWriteOff,
			xt.app_status_agency AS listStatusOfAgency,
			xt.app_status_store aslistStatusOfStore,
-- 			dt.yuansdStatus AS sfStatus,
			xt.dingdRemark AS serviceRemark,
			xt.oms_status AS oms_status
		FROM
			dbo.tb_sd_xiaos_title xt
			LEFT JOIN dbo.tb_sd_xiaos_list xl ON xt.xiaosTitleID = xl.xiaosTitleID
			LEFT JOIN dbo.tb_sys_record_shangp sp ON sp.shangpID = xl.shangpID
			LEFT JOIN dbo.tb_sd_tuih_title tt ON xt.xiaosTitleID = tt.xiaosTitleID
			INNER JOIN dbo.tb_sys_record_keh kh ON kh.kehCode = xt.kehCode
			INNER JOIN dbo.tb_sd_dingd_title dt ON dt.dingdTitleID = xt.dingdTitleID
			INNER JOIN dbo.tb_sys_record_org org ON dt.yewOrgID = org.orgID
		WHERE
			1 = 1
			AND dt.dingdLeix = '2'
			AND xt.xiaosTitleID = #{prePayId}
	</select>

	<insert id="insert">
		insert into dbo.tb_sd_xiaos_operation(
		tmall_orderId,
		operate_id,
		operate_dec,
		operate_type,
		operate_remark,
		operate_time,
		operate_name
		) values (
		#{template.prePayOrder},
		#{template.operatorBy},
		#{template.operatorDesc},
		#{template.operatorType},
		#{template.operatorRemark},
		#{template.operatorTimeSave},
		#{template.operatorByName}
		)
	</insert>

	<resultMap id="productDataMap" type="com.dpmall.db.bean.TmallOrderProductModeIn">
		<id property="id" column="id" />
		<result property="tmallOrderId" column="tmall_orderId" />
		<result property="productCode" column="product_code" />
		<result property="productCatetory" column="product_catetory" />
		<result property="quantity" column="quantity" />
		<result property="amount" column="amount" />
		<result property="productDescribe" column="product_describe" />
		<result property="unit" column="unit" />
		<result property="unitPrice" column="unit_price" />
		<result property="shangpId" column="shangp_id" />

	</resultMap>

	<select id="getTmallOrderProductList" resultMap="productDataMap">
			SELECT
				xtp.id as id,
				xtp.tmall_orderId as tmall_orderId,
				xtp.product_code as product_code,
				xtp.product_catetory as product_catetory,
				xtp.quantity as quantity,
				xtp.amount as amount,
				xtp.product_describe as product_describe,
				xtp.unit as unit,
				xtp.unit_price as unit_price,
				xtp.shangp_id as shangp_id
			FROM
				dbo.tb_sd_xiaos_title xt
				LEFT JOIN dbo.tb_sd_xiaos_title_product xtp ON xt.xiaosTitleID = xtp.tmall_orderId
			WHERE 1 = 1
				  AND xt.xiaosTitleID = #{orderId}
				  AND xtp.is_delete = '0'
	</select>


	<select id="getProduct" resultMap="productDataMap">
			SELECT
				xtp.id as id,
				xtp.tmall_orderId as tmall_orderId,
				xtp.product_code as product_code,
				xtp.product_catetory as product_catetory,
				xtp.quantity as quantity,
				xtp.amount as amount,
				xtp.product_describe as product_describe,
				xtp.unit as unit,
				xtp.unit_price as unit_price,
				xtp.shangp_id as shangp_id
			FROM
				dbo.tb_sd_xiaos_title_product xtp
			WHERE 1 = 1
				  AND xtp.shangp_id = #{shangpId}
				  AND xtp.is_delete = '0'
	</select>

	<insert id="addProduct">
		insert into dbo.tb_sd_xiaos_list(
			chuangjTime,
			xiugTime,
			xiaosTitleID,
		<if test="entity.productCode!=null and entity.productCode !=''">
			shangpCode,
		</if>
		<if test="entity.amount!=null and entity.amount !=''">
			amount,
		</if>
		<if test="entity.unitPrice!=null and entity.unitPrice !=''">
			unitPrice,
		</if>
		<if test="entity.shangpId!=null and entity.shangpId !=''">
			shangpID,
		</if>
		<if test="entity.quantity!=null and entity.quantity !=''">
			quantity,
		</if>
		<if test="entity.unit!=null and entity.unit !=''">
			unit,
		</if>
		isDelete
		) VALUES (
		SYSDATETIME(),
		SYSDATETIME(),
		#{entity.tmallOrderId},
		<if test="entity.productCode!=null and entity.productCode !=''">
			#{entity.productCode},
		</if>
		<if test="entity.amount!=null and entity.amount !=''">
			#{entity.amount},
		</if>
		<if test="entity.unitPrice!=null and entity.unitPrice !=''">
			#{entity.unitPrice},
		</if>
		<if test="entity.shangpId!=null and entity.shangpId !=''">
			#{entity.shangpId},
		</if>
		<if test="entity.quantity!=null and entity.quantity !=''">
			#{entity.quantity},
		</if>
		<if test="entity.unitPrice!=null and entity.unitPrice !=''">
			#{entity.unitPrice},
		</if>
		'0'
		)
	</insert>

	<update id="editProduct">
		<if test="entity.orderItemId !=null and entity.orderItemId !=''">
			UPDATE  dbo.tb_sd_xiaos_list
			<set>
				xiugTime=SYSDATETIME(),
				<if test="entity.productCode!=null and entity.productCode!=''">
					shangpCode=#{entity.productCode},
				</if>
				<if test="entity.amount!=null and entity.amount!=''">
					amount=#{entity.amount},
				</if>
				<if test="entity.unitPrice!=null and entity.unitPrice!=''">
					unitPrice=#{entity.unitPrice},
				</if>
				<if test="entity.quantity!=null and entity.quantity!=''">
					quantity=#{entity.quantity},
				</if>
				<if test="entity.unit!=null and entity.unit!=''">
					unit=#{entity.unit},
				</if>

			</set>
			where xiaosListID=#{entity.orderItemId}
		</if>

	</update>

	<update id="delete">
		UPDATE dbo.tb_sd_xiaos_title_product
		<set>
			is_delete='1'
		</set>
		where shangp_id IN
		<foreach collection="entity" index="index" item="item" open="(" separator="," close=")">
			${item}
		</foreach>
	</update>


	<select id="getIsAgency" resultType="java.lang.String">
		select
			xt.isDeliverSelf
			from
			dbo.tb_sd_xiaos_title xt
			where 1=1
			and xt.xiaosTitleID = #{tmallOrderId}
	</select>

	<update id="updateTmallOrderProduct">
		update
		tb_sd_xiaos_title_product
		<set>
			<if test="entity.quantity!=null and entity.quantity!=''">
				quantity=#{entity.quantity},
			</if>
			<if test="entity.amount!=null and entity.amount!=''">
				amount=#{entity.amount},
			</if>
			<if test="entity.unitPrice!=null and entity.unitPrice!=''">
				unit_price=#{entity.unitPrice},
			</if>
			update_time = GETDATE()
		</set>
		where id=#{entity.id}
	</update>

	<insert id="addTmallOrderProduct">
		INSERT INTO
		dbo.tb_sd_xiaos_title_product
		(
		<if test="tmallId != null and tmallId !=''">
			tmall_orderId,
		</if>
		<if test="entity.productCode != null and entity.productCode !=''">
			product_code,
		</if>
		<if test="entity.category != null and entity.category !=''">
			product_catetory,
		</if>
		<if test="entity.quantity != null and entity.quantity !=''">
			quantity,
		</if>
		<if test="entity.amount != null and entity.amount !=''">
			amount,
		</if>
		<if test="entity.productName != null and entity.productName !=''">
			product_describe,
		</if>
		<if test="entity.unit != null and entity.unit !=''">
			unit,
		</if>
		<if test="entity.unitPrice != null and entity.unitPrice !=''">
			unit_price,
		</if>
		<if test="entity.productId != null and entity.productId !=''">
			shangp_id,
		</if>
		create_time,
		is_delete
		)
		VALUES
		(
		<if test="tmallId != null and tmallId !=''">
			#{tmallId},
		</if>
		<if test="entity.productCode != null and entity.productCode !=''">
			#{entity.productCode},
		</if>
		<if test="entity.category != null and entity.category !=''">
			#{entity.category},
		</if>
		<if test="entity.quantity != null and entity.quantity !=''">
			#{entity.quantity},
		</if>
		<if test="entity.amount != null and entity.amount !=''">
			#{entity.amount},
		</if>
		<if test="entity.productName != null and entity.productName !=''">
			#{entity.productName},
		</if>
		<if test="entity.unit != null and entity.unit !=''">
			#{entity.unit},
		</if>
		<if test="entity.unitPrice != null and entity.unitPrice !=''">
			#{entity.unitPrice},
		</if>
		<if test="entity.productId != null and entity.productId !=''">
			#{entity.productId},
		</if>
		GETDATE(),
		'0'
		);
	</insert>

        </mapper>