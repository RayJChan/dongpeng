<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.ReportDao">
	
	<resultMap id="reportResultMap" type="com.dpmall.db.bean.ReportEntity">
		<id property="id" column="PK" />
		<result property="agencyId" column="agencyId"/>
		<result property="storeId" column="storeId"/>
		<result property= "count" column="count"/>
		<result property= "acceptTimeSum" column="acceptTimeSum"/>
		<result property= "deliverTimeSum" column="deliverTimeSum"/>
		<result property= "salesSuccessCount" column="salesSuccessCount"/>
		<result property= "salesSuccessPrice" column="salesSuccessPrice"/>
	</resultMap>
	
	<!--实物 OMS 派单给经销商数量-->
	<select id="orderDistributCount" resultType="java.lang.Integer">
		select count(1) 
		from CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
								where 1=1 
								AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startTime}
								AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{endTime}
								and P_ALLOCATIONEMPLOYEECODE=#{agencyId}
								AND P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
	
	</select>
	
	<!-- 实物，经销商接单数量 -->
	<select id="orderAgencyAcceptCount" resultType="java.lang.Integer">
		select count(1) from CONSIGNMENTS C ,O2OCONSIGNMENTITEMS O WHERE C.PK=o.P_CONSIGNMENT
								AND TO_CHAR (O.P_DISTRIBUTETIME, 'YYYY-MM-DD') &gt;= #{startTime}
								AND TO_CHAR (O.P_DISTRIBUTETIME, 'YYYY-MM-DD') &lt;= #{endTime}
								and C.P_ALLOCATIONEMPLOYEECODE=#{agencyId}
								and o.P_DISTRIBUTETIME IS NOT NULL
								AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
	</select>
	
	<!-- 实物，经销商下派门店数量-->
	<select id="orderAgencyToStoreCount" resultType="java.lang.Integer">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
		WHERE
			1 = 1
		and o2o.P_DISTRIBUTETIME IS NOT NULL
		AND TO_CHAR (o2o.P_DISTRIBUTETIME, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (o2o.P_DISTRIBUTETIME, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE  IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		<if test="storeId != null">
			AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
		</if>
	</select>
	
	<!--实物 门店的接单数量  -->
	<select id="orderStoreAcceptCount"  resultType="java.lang.Integer">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
		WHERE
			1 = 1
		AND o2o.P_ACCEPTEDTIME IS NOT NULL
		AND TO_CHAR (o2o.P_ACCEPTEDTIME, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (o2o.P_ACCEPTEDTIME, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE IN('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	
	<!--特权订金 OMS 派单给经销商数量-->
	<select id="prePayDistributCount"  resultType="java.lang.Integer">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
		WHERE
			1 = 1
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE = 'M2'
		AND c.P_ALLOCATIONEMPLOYEECODE = #{agencyId}
	</select>
	
	<!-- 特权定金，经销商接单数量 -->
	<select id="prePayAgencyAcceptCount" resultType="java.lang.Integer">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
		WHERE
			1 = 1
		and o2o.P_DISTRIBUTETIME IS NOT NULL
		AND TO_CHAR (o2o.P_DISTRIBUTETIME, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (o2o.P_DISTRIBUTETIME, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE = 'M2'
		<if test="agencyId != null">
			AND c.P_ALLOCATIONEMPLOYEECODE = #{agencyId}
		</if>
	</select>
	
	<!-- 特权定金，经销商下派门店数量-->
	<select id="prePayAgencyToStoreCount" resultType="java.lang.Integer">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
		WHERE
			1 = 1
		and o2o.P_DISTRIBUTETIME IS NOT NULL
		AND TO_CHAR (o2o.P_DISTRIBUTETIME, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (o2o.P_DISTRIBUTETIME, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE = 'M2'
		<if test="storeId != null">
			AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
		</if>
	</select>
	
	<!--特权定金 门店的接单数量  -->
	<select id="prePayStoreAcceptCount"  resultType="java.lang.Integer">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
		WHERE
			1 = 1
		AND o2o.P_ACCEPTEDTIME IS NOT NULL
		AND TO_CHAR (o2o.P_ACCEPTEDTIME, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (o2o.P_ACCEPTEDTIME, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE = 'M2'
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	<!-- 特权订金 核销数量 -->
	<select id="prePayWriteOffCount"  resultType="java.lang.Integer">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		LEFT JOIN PRIDEPOSITINFO P ON P .P_CONSIGNMENTCODE = c.P_CODE
		WHERE
			1 = 1
		AND P .P_ISWRITEOFF = '1'
		AND TO_CHAR (P.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (P.CREATEDTS, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE = 'M2'
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	<!--  经销商对应的门店的接单数量 -->
	<select id="prePayStoreAcceptCountOfAgency" resultMap="reportResultMap">
		SELECT
			c.P_DELIVERYPOINTOFSERVICE as storeId,
			COUNT (1) as count
		FROM
			CONSIGNMENTS c
		LEFT JOIN O2OCONSIGNMENTITEMS o2o ON c.pk = o2o.P_CONSIGNMENT
		WHERE
			1 = 1
		AND o2o.P_ACCEPTEDTIME IS NOT NULL
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD')  &gt;= #{startTime}
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{endTime}
		AND c.P_SPLITORDERTYPE = 'M2'
		AND c.P_ALLOCATIONEMPLOYEECODE = #{agencyId}
		GROUP BY
			c.P_DELIVERYPOINTOFSERVICE
	</select>
<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~NEW~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->	
	
	<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~实物~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->	
	
	
	<!-- oms下派给经销商 数量-->
	<select id="distributedOrders4Agency" resultType="java.math.BigDecimal">
		SELECT
			count(*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		WHERE 
		1=1
	   	AND o2o.P_AGENCYO2OSTATUS IS NOT NULL
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
       AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	   AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
       AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
	</select>


<!-- oms接单 数量-->
	<select id="acceptOrders4Agency" resultType="java.math.BigDecimal">
		SELECT
			COUNT (*)
		FROM
			CONSIGNMENTS c
		inner JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		WHERE
			1 = 1
		AND o.P_AGENCYO2OSTATUS IN ('INPROGRESS','WAITFORREFUND','COMPLETED','CLOSED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	</select>
	
		
	<!-- 实物：经销商 接单时间-派单时间的差值的总和 -->
	<select id="acceptTimeSum4Agency"  resultType="java.math.BigDecimal">
		SELECT
		  sum(ceil(((CAST(O.P_DISTRIBUTETIME AS DATE))-(CAST(O.CREATEDTS AS DATE))) * 24 * 60 * 60 )) as acceptTimeSum
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		WHERE
			1 = 1
		AND o.P_DISTRIBUTETIME IS NOT NULL
	    AND o.CREATEDTS IS NOT NULL
	    AND o.P_AGENCYO2OSTATUS IS NOT NULL
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	</select>
	
	<!-- 实物：经销商  发货时间-接单时间的差值的总和  -->
	<select id="deliveryTimeSum4Agency"  resultType="java.math.BigDecimal">
		SELECT
		  sum(ceil(((CAST(O.P_DELIVERYTIME AS DATE))-(CAST(O.P_ACCEPTEDTIME AS DATE))) * 24 * 60 * 60 )) as deliverTimeSum
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		WHERE
			1 = 1
		AND o.P_AGENCYO2OSTATUS IN ('INPROGRESS','WAITFORREFUND','COMPLETED','CLOSED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND P_DISTRIBUTETIME IS NOT NULL
	    AND P_ACCEPTEDTIME IS NOT NULL
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
	 	AND ( c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	</select>

	
	<!-- oms派单给门店 数量-->
	<select id="distributedOrders4Store" resultType="java.math.BigDecimal">
		SELECT
			COUNT (*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		WHERE
			1 = 1 
		AND o.P_STOREO2OSTATUS IS NOT NULL
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	
	</select>
	
	<!-- 门店接单 数量-->
	<select id="acceptOrders4Store" resultType="java.math.BigDecimal">
		SELECT
			COUNT (*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		WHERE
			1 = 1 
		 AND o.P_STOREO2OSTATUS in('WAITFORREFUND','INPROGRESS','COMPLETED','CLOSED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	
		
	<!-- 门店 接单时间-派单时间的差值的总和 -->
	<select id="acceptTimeSum4Store"  resultType="java.math.BigDecimal">
		SELECT
		  sum(ceil(((CAST(O.P_ACCEPTEDTIME AS DATE))-(CAST(O.P_DISTRIBUTETIME AS DATE))) * 24 * 60 * 60 )) as acceptTimeSum
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		WHERE
			1 = 1
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND P_DISTRIBUTETIME IS NOT NULL
	    AND P_ACCEPTEDTIME IS NOT NULL
	    AND o.P_STOREO2OSTATUS IS NOT NULL
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		 
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	<!-- 门店  发货时间-接单时间的差值的总和  -->
	<select id="deliveryTimeSum4Store"  resultType="java.math.BigDecimal">
		SELECT
		  sum(ceil(((CAST(O.P_DELIVERYTIME AS DATE))-(CAST(O.P_ACCEPTEDTIME AS DATE))) * 24 * 60 * 60 )) as deliverTimeSum
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		WHERE
			1 = 1
		AND o.P_STOREO2OSTATUS IN (
			'COMPLETED',
			'CLOSED',
			'WAITFORREFUND',
			'INPROGRESS'
		)
		 AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND P_DISTRIBUTETIME IS NOT NULL
	    AND P_ACCEPTEDTIME IS NOT NULL
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		  
	 	AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	<!-- 发货 数量-->
	<select id="deliveryOrdersCounts" resultType="java.math.BigDecimal">
		SELECT
			COUNT(*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O ON C.PK = O.P_CONSIGNMENT
		INNER JOIN ENUMERATIONVALUES t2 ON t2.pk = c.P_STATUS
		INNER JOIN COMPOSEDTYPES t1 ON t2.TYPEPKSTRING = t1.PK
		WHERE
			1 = 1
		AND t1.INTERNALCODe = 'ConsignmentStatus'
		AND t2.code IN ('SHIPPED','REMITTED','RECEIVE','DPRECEIVE','COMPLETED','RETRIEVED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		<if test="storeId != null and storeId !='' ">
			and c.P_DELIVERYPOINTOFSERVICE=#{storeId} 
		</if>
		<if test="list != null  ">
		AND  (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
		</if>
	</select>
	
	<!-- oms下派给经销商 总价 web类型-->
	<select id="distributeTotal4AgencyOfYes" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_JUNTANPRICE,oe.P_JUNTANPRICE,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		left JOIN ORDERS O ON C.P_ORDER = O.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1 
		AND o2o.P_AGENCYO2OSTATUS IS NOT NULL
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND E2.code = 'Web'
		
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
       AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	   AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
	</select>
	
	<!-- oms下派给经销商 总价 非web类型-->
	<select id="distributeTotal4AgencyOfNo" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_payAmount,oe.P_payAmount,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		left JOIN ORDERS O ON C.P_ORDER = O.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1 
		AND o2o.P_AGENCYO2OSTATUS IS NOT NULL
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND E2.code != 'Web'
		
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
       AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	   AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
	</select>
	
	<!-- oms接单 总价 web类型-->
	<select id="acceptTotal4AgencyOfYes" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_JUNTANPRICE,oe.P_JUNTANPRICE,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		inner JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		left JOIN ORDERS O2 ON C.P_ORDER = O2.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o2.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1
		AND E2.code = 'Web'
		AND o.P_AGENCYO2OSTATUS IN ('INPROGRESS','WAITFORREFUND','COMPLETED','CLOSED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		AND ( c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	</select>
	
	<!-- oms接单  总价 非web类型-->
	<select id="acceptTotal4AgencyOfNo" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_payAmount,oe.P_payAmount,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		inner JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		left JOIN ORDERS O2 ON C.P_ORDER = O2.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o2.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1
		AND E2.code != 'Web'	
		AND o.P_AGENCYO2OSTATUS IN ('INPROGRESS','WAITFORREFUND','COMPLETED','CLOSED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	</select>
	
	
	<!-- oms派单给门店 web类型-->
	<select id="distributeTotal4StoreOfYes" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_JUNTANPRICE,oe.P_JUNTANPRICE,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		left JOIN ORDERS O2 ON C.P_ORDER = O2.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o2.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1 
		AND E2.code = 'Web'
		AND o.P_STOREO2OSTATUS IS NOT NULL
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	
	</select>
	
	<!-- oms派单给门店 非web类型-->
	<select id="distributeTotal4StoreOfNo" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_payAmount,oe.P_payAmount,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		left JOIN ORDERS O2 ON C.P_ORDER = O2.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o2.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1 
		AND E2.code != 'Web'
		AND o.P_STOREO2OSTATUS IS NOT NULL
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	<!-- 门店接单 总价 web类型-->
	<select id="acceptTotal4StoreOfYes" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_JUNTANPRICE,oe.P_JUNTANPRICE,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		left JOIN ORDERS O2 ON C.P_ORDER = O2.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o2.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1 
		AND E2.code = 'Web'	
		AND o.P_STOREO2OSTATUS in('WAITFORREFUND','INPROGRESS','COMPLETED','CLOSED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	<!-- 门店接单  总价 非web类型-->
	<select id="acceptTotal4StoreOfNo" resultType="java.math.BigDecimal">
		SELECT
			sum((NVL2(oe.P_DELIVERYCOST,oe.P_DELIVERYCOST,0) ) + (NVL2(oe.P_payAmount,oe.P_payAmount,0))+ (NVL2(oe.P_SERVICEAMOUNT,oe.P_SERVICEAMOUNT,0) )) as count
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		left JOIN ORDERS O2 ON C.P_ORDER = O2.PK
		left JOIN CONSIGNMENTENTRIES c2 ON c2.P_CONSIGNMENT = c.pk
		left JOIN ORDERENTRIES oe ON c2.P_ORDERENTRY = oe.pk
		left JOIN ENUMERATIONVALUES E2 ON o2.P_SALESAPPLICATION = E2.PK
		WHERE
			1 = 1
		AND E2.code != 'Web'	 
		AND o.P_STOREO2OSTATUS in('WAITFORREFUND','INPROGRESS','COMPLETED','CLOSED')
		AND C.P_SPLITORDERTYPE IN ('A1','A2','B1','B2','C1','C2','D1','D2','E1','E2','F1','F2','O2') 
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	

	
	
	<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~特权定金~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->	
	<!--特权 oms下派给经销商 数量-->
	<select id="distributedPrepay4Agency" resultType="java.math.BigDecimal">
		SELECT
			count(*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK=O2O.P_CONSIGNMENT
		WHERE 
		1=1
		AND ( c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
      	AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		 
      	AND c.P_SPLITORDERTYPE = 'M2'
     </select>
     
     <!--特权 经销商接单 数量-->
     <select id="acceptPrepay4Agency" resultType="java.math.BigDecimal">
		SELECT
			count(*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		LEFT JOIN ENUMERATIONVALUES t2 ON t2.pk = c.P_STATUS
		LEFT JOIN COMPOSEDTYPES t1 ON t2.TYPEPKSTRING = t1.PK
		WHERE 
		1=1
		AND t1.INTERNALCODe = 'ConsignmentStatus'
		AND t2.code NOT IN ('DISTRIBUTED')
		AND ( c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
      	AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
		 
      	AND c.P_SPLITORDERTYPE = 'M2'
     </select>
     
      
     <!--特权 经销商下派给门店 数量-->
     <select id="distributePrepayOfStore" resultType="java.math.BigDecimal">
		SELECT
			count(*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		<!-- LEFT JOIN ENUMERATIONVALUES t2 ON t2.pk = c.P_STATUS
		LEFT JOIN COMPOSEDTYPES t1 ON t2.TYPEPKSTRING = t1.PK
 -->		WHERE 
		1=1
		<!-- AND t1.INTERNALCODe = 'ConsignmentStatus'
		AND t2.code  IN ('STOREWAIT','TOSTORE','ALLOCATED','BOOKED','SHIPPED','DPRECEIVE','ACCEPT','COMPLETED','RECEIVE','NOTTRADED')
 -->    AND c.P_SPLITORDERTYPE = 'M2'
      	AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
      	AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
     </select>
     
      <!--特权 门店接单 数量-->
     <select id="acceptPrepayOfStore" resultType="java.math.BigDecimal">
		SELECT
			count(*)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		 LEFT JOIN ENUMERATIONVALUES t2 ON t2.pk = c.P_STATUS
		LEFT JOIN COMPOSEDTYPES t1 ON t2.TYPEPKSTRING = t1.PK
		WHERE 
		1=1
		AND t1.INTERNALCODe = 'ConsignmentStatus'
		AND t2.code  IN ('TOSTORE','ALLOCATED','BOOKED','SHIPPED','DPRECEIVE','ACCEPT','COMPLETED','RECEIVE','NOTTRADED')
       	AND c.P_SPLITORDERTYPE = 'M2'
      	AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
   		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
     </select>
     
      <!-- 特权订金 经销商 核销数量 -->
	<select id="prePayWriteOffOfAgency"  resultType="java.math.BigDecimal">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		LEFT JOIN PRIDEPOSITINFO P ON P .P_CONSIGNMENTCODE = c.P_CODE
		WHERE
			1 = 1
		AND P.P_ISWRITEOFF = '1'
		<!-- and O2O.P_DISTRIBUTETIME  is not null  -->
		AND c.P_SPLITORDERTYPE = 'M2'
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
	</select>
     
     
     <!-- 特权订金 门店 核销数量 -->
	<select id="prePayWriteOffOfStrore"  resultType="java.math.BigDecimal">
		SELECT
			COUNT (1)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		LEFT JOIN PRIDEPOSITINFO P ON P .P_CONSIGNMENTCODE = c.P_CODE
		WHERE
			1 = 1
		AND P.P_ISWRITEOFF = '1'
		 and O2O.P_DISTRIBUTETIME  is not null  
		AND c.P_SPLITORDERTYPE = 'M2'
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
	</select>
	
	<!-- 经销商 核销时间-接单时间的差值的总和 -->
	<select id="writeOffTimeSum4Agency"  resultType="java.math.BigDecimal">
		SELECT
		  sum(ceil(((CAST(p.P_WRITEOFFTIME AS DATE))-(CAST(O.P_DISTRIBUTETIME AS DATE))) * 24 * 60 * 60 )) as acceptTimeSum
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		LEFT JOIN PRIDEPOSITINFO P ON P .P_CONSIGNMENTCODE = c.P_CODE
		WHERE
			1 = 1
		AND P_DISTRIBUTETIME IS NOT NULL
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
		AND (c.P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       	</foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or c.P_ALLOCATIONEMPLOYEECODE in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	</select>
	
	<!-- 门店 核销时间-接单时间的差值的总和 -->
	<select id="writeOffTimeSum4Store"  resultType="java.math.BigDecimal">
		SELECT
		  sum(ceil(((CAST(p.P_WRITEOFFTIME AS DATE))-(CAST(O.P_DISTRIBUTETIME AS DATE))) * 24 * 60 * 60 )) as acceptTimeSum
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS o ON o.pk = c.P_O2OCONSIGNMENTITEM
		LEFT JOIN PRIDEPOSITINFO P ON P .P_CONSIGNMENTCODE = c.P_CODE
		WHERE
			1 = 1
		AND P_DISTRIBUTETIME IS NOT NULL
		AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
	</select>
	
	   <!-- 特权订金 经销商 核销金额总和 -->
	<select id="writeOffPriceOfAgency"  resultType="java.math.BigDecimal">
		SELECT
			sum(P .P_ORDERTOTAL)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		LEFT JOIN PRIDEPOSITINFO P ON P .P_CONSIGNMENTCODE = c.P_CODE
		WHERE
			1 = 1
		and O2O.P_DISTRIBUTETIME  is not null  <!-- 确保与核销时间数据一致 -->
		AND P .P_ISWRITEOFF = '1' 
		AND c.P_SPLITORDERTYPE = 'M2'
		AND P_ALLOCATIONEMPLOYEECODE IN 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
            #{item}  
       </foreach>
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
	</select>
	
	   <!-- 特权订金 门店 核销金额总和 -->
	<select id="writeOffPriceOfStore"  resultType="java.math.BigDecimal">
		SELECT
			sum(P.P_ORDERTOTAL)
		FROM
			CONSIGNMENTS c
		INNER JOIN O2OCONSIGNMENTITEMS O2O ON C.PK = O2O.P_CONSIGNMENT
		LEFT JOIN PRIDEPOSITINFO P ON P .P_CONSIGNMENTCODE = c.P_CODE
		WHERE
			1 = 1
		and O2O.P_DISTRIBUTETIME  is not null  <!-- 确保与核销时间数据一致 -->
		AND P .P_ISWRITEOFF = '1' 
		AND c.P_SPLITORDERTYPE = 'M2'
		AND c.P_DELIVERYPOINTOFSERVICE = #{storeId}
		AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (o2o.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
	</select>
	
	
	<!--  -->
	
	<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~留资~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->	
	
	<!--留资 oms下派给经销商 数量-->
	<select id="distributeSalesLeadsOfAgency"  resultType="java.math.BigDecimal" >
		SELECT
			COUNT (*)
		FROM
			SALESLEADSORDER so
		Inner JOIN AGENCY ag ON AG.pk = SO.P_AGENCY
		WHERE 
		1=1
			AND (AG.P_UID IN 
			<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
	            #{item}  
	       </foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or AG.P_UID in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	    AND SO.P_DISTRIBUTEDATE IS NOT NULL  
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
     </select>
     
     <!--留资 经销商 接单数量-->
	<select id="acceptSalesLeadsOfAgency"  resultType="java.math.BigDecimal" >
		SELECT
			COUNT (*)
		FROM
			SALESLEADSORDER so
		Inner JOIN AGENCY ag ON AG.pk = SO.P_AGENCY
		WHERE 
		1=1
			AND (AG.P_UID IN 
			<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
	            #{item}  
	       </foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or AG.P_UID in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
	   and SO.P_SALESLEADSORDERSTATUS in ('10','15','20','23','25','30')   
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
     </select>
     
     
      <!--留资 经销商下派门店 数量-->
	<select id="distributeSalesLeadsOfStore"  resultType="java.math.BigDecimal" >
		SELECT
			COUNT (*)
		FROM
			SALESLEADSORDER so
		WHERE 
		1=1
	   and So.P_ACCEPTSTORE=#{storeId} 
	   and SO.P_SALESLEADSORDERSTATUS in ('10','15','20','23','25','30')   
	   AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	   AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
     </select>
     
       <!--留资 门店接单 数量-->
	<select id="acceptSalesLeadsOfStore"  resultType="java.math.BigDecimal" >
		SELECT
			COUNT (*)
		FROM
			SALESLEADSORDER so
		WHERE 
		1=1
	   and So.P_ACCEPTSTORE=#{storeId} 
	   and SO.P_SALESLEADSORDERSTATUS in ('15','20','23','25','30')   
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
     </select>
     
     
    <!--留资 转化成功的数量-->
	<select id="salesLeadsSuccessfulCount"  resultType="java.math.BigDecimal" >
		SELECT
			COUNT (*)
		FROM
			SALESLEADSORDER so
		INNER JOIN AGENCY ag ON AG.pk = SO.P_AGENCY
		WHERE 
		1=1
		<if test="storeId != null and storeId !='' ">
			and So.P_ACCEPTSTORE=#{storeId} 
		</if>
		<if test="list != null  ">
		AND (AG.P_UID IN 
			<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
	            #{item}  
	       </foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or AG.P_UID in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
		</if>
	   and SO.P_SALESLEADSORDERSTATUS ='25' 
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
     </select>
     
      <!--留资 转化成功的金额总价-->
	<select id="salesLeadsSuccessPrice"  resultType="java.math.BigDecimal" >
		SELECT
			sum(SO.P_AMOUNT)  
		FROM
			SALESLEADSORDER so
		INNER JOIN AGENCY ag ON AG.pk = SO.P_AGENCY
		WHERE 
		1=1
		<if test="storeId != null and storeId !='' ">
			and So.P_ACCEPTSTORE=#{storeId} 
		</if>
		<if test="list != null  ">
		AND (AG.P_UID IN 
			<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
	            #{item}  
	       </foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or AG.P_UID in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
		</if>
	   	and SO.P_SALESLEADSORDERSTATUS ='25' 
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}
  
     </select>
    
     <!-- 转化成功时间-接单时间 -->
	<select id="salesLeadsSuccessTimes"  resultType="java.math.BigDecimal">
		SELECT
			 sum(ceil(((CAST(so.P_FINISHEDDATE AS DATE))-(CAST(so.P_ACCEPTDATE AS DATE))) * 24 * 60 * 60 )) as acceptTimeSum
		FROM
			SALESLEADSORDER so
		INNER JOIN AGENCY ag ON AG.pk = SO.P_AGENCY
		WHERE
			1 = 1
		AND SO.P_SALESLEADSORDERSTATUS = '25'
		<if test="storeId != null and storeId !='' ">
			and So.P_ACCEPTSTORE=#{storeId} 
		</if>
		<if test="list != null  ">
		AND (AG.P_UID IN 
			<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
	            #{item}  
	       </foreach>
       	<if test="bigList != null">
			 <foreach collection="bigList" index="index" item="item2" >  
	             or AG.P_UID in
	             <foreach collection="item2" index="index" item="item3" open="(" separator="," close=")" >  
	            	#{item3}  
	       		 </foreach>
	       	 </foreach>
       	</if>)
		</if>
		AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &gt;= #{startdate}
	    AND TO_CHAR (So.CREATEDTS, 'YYYY-MM-DD') &lt;= #{enddate}

	</select>
	<select id="getRoleCode" resultType="String">
	SELECT
		ar.p_rolecode
	FROM
		APPGROUP ag
	LEFT JOIN APPUSER ap ON AP.P_GROUP = ag.pk
	LEFT JOIN APPROLE ar ON AP.p_role = ar.pk
	WHERE
		p_code = #{code}
	</select>
	
	
	<resultMap id="contrastResultMap" type="com.dpmall.db.bean.ReportDetailEntity">
		<id property="id" column="PK" />
		<result property="appGroup" column="appGroup"/>
		<result property="storeId" column="storeId"/>
		<result property="historyDate" column="historyDate"/>
		<result property="distributeCount" column="distributeCount"/>
		<result property="acceptCount" column="acceptCount"/>
		<result property="distributeAVG" column="distributeAVG"/>
		<result property="acceptAVG" column="acceptAVG"/>
		<result property="acceptRate" column="acceptRate"/>
		<result property="deliverAVGTime" column="deliverAVGTime"/>
		
		<result property="writeOffDistributeCount" column="writeOffDistributeCount"/>
		<result property="writeOffCount" column="writeOffCount"/>
		<result property="writeOffAVG" column="writeOffAVG"/>
		<result property="writeOffRate" column="writeOffRate"/>
		<result property="writeOffTime" column="writeOffTime"/>
		
		<result property="conversionCount" column="conversionCount"/>
		<result property="conversionAVG" column="conversionAVG"/>
		<result property="conversionRate" column="conversionRate"/>
		<result property="conversionAVGTime" column="conversionAVGTime"/>
	</resultMap>
	
	<!-- 查询历史数据 做对比 -->
	<select id="getContrastInfo"  resultMap="contrastResultMap">
		SELECT
			h.p_time as  historyDate,
			H.P_APPGROUP as appGroup,
			H.P_STORE as storeId,
			H .P_PDQUANTITY AS distributeCount,
			H .P_JDQUANTITY AS acceptCount,
			H .P_PDAVERAGE AS distributeAVG,
			H .P_JDAVERAGE AS acceptAVG,
			H .P_JDTOTALPERCENT AS acceptRate,
			H .P_FHAVERAGETIME AS deliverAVGTime,
			
			H .P_TQPDQUANTITY AS writeOffDistributeCount,
			H .P_TQHXQUANTITY AS writeOffCount,
			H .P_TQHXAVERAGE AS writeOffAVG,
			H .P_TQHXPERCENT AS writeOffRate,
			H .P_TQHXTIME AS writeOffTime,
			
			H .P_LZZHQUANTITY AS conversionCount,
			H .P_LZZHAVERAGE AS conversionAVG,
			H .P_LZZHPERCENT AS conversionRate,
			H .P_LZZHTIME  AS conversionAVGTime
		FROM
			<if test='dateFormat == "MONTH"'>
				HISTORICRECORDS H
			</if>
			<if test='dateFormat == "QUARTER"'>
				SHISTORICRECORDS H
			</if>
			<if test='dateFormat == "YEAR"'>
				YHISTORICRECORDS H
			</if>
		WHERE
			1 = 1 
		<if test='isStore == "Y"'>
			AND  H.P_STORE = #{storeId}
		</if>
		<if test='isStore == "N"'>
		AND H.P_APPGROUP = (
			SELECT
				pk
			FROM
				APPGROUP
			WHERE
				P_CODE = #{code}
		)
		</if>
		AND TO_CHAR (H .P_TIME, 'YYYY-MM-DD') &gt;= #{startTime}
		AND TO_CHAR (H .P_TIME, 'YYYY-MM-DD') &lt;= #{endTime}
	
	</select>
	
	
</mapper>